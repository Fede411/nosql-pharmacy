<!DOCTYPE html>

<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">

    <script src="https://unpkg.com/@popperjs/core@^2.0.0"></script>
    <script src="/javascripts/jquery-3.2.1.min.js"></script>
    <script src="/javascripts/bootstrap.js"></script>
    <script src="/javascripts/bootstrap-datepicker.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <link rel='stylesheet' href='/stylesheets/bootstrap.css' />
    <link rel='stylesheet' href='/stylesheets/bootstrap-datepicker.css' />
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css"
        integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">

</head>

<body>

    <div class="container-fluid">
        <div class="row">
            <nav class="navbar navbar-expand-md fixed-top navbar-dark bg-primary">
                <div id="brand" class="col-xl-2 col-lg-3 col-md-3">
                    <a class="navbar-brand" href="/inicio"><b>PHARMACY</b></a>
                    <button style="float: right;" class="navbar-toggler collapsed" type="button" data-toggle="collapse"
                        data-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false"
                        aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                </div>
                <div id="items" class="col-xl-10 col-lg-9 col-md-9">
                    <div class="navbar-collapse collapse" id="navbarColor01" style="">
                        <ul class="navbar-nav mr-auto">
                            <li class="nav-item">
                                <a class="nav-link" href="/dispensacion"><i
                                        style="margin-right: 15.5px; margin-left: 5px;" class="fas fa-user-injured"></i>
                                    <b>DISPENSATION PROGRAMS</b></a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/consumos_acumulados"><i
                                        style="margin-right: 15.5px; margin-left: 5px;" class="fas fa-user-injured"></i>
                                    <b>ACCUMULATED CONSUMPTION</b></a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/estadisticas"><i
                                        style="margin-right: 15.5px; margin-left: 5px;" class="fas fa-chart-line"></i>
                                    <b>STATISTICS</b></a>
                            </li>

                        </ul>
                    </div>
                </div>
            </nav>
        </div>
        <div class="row content">
            <div class="col-xl-2 col-lg-3 col-md-3 col-12 patient-filter">
                <div>
                    <h2><b>FILTERS</b></h2>
                    <ul class="nav nav-pills flex-column" id="myTab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link" id="filteractuacionesByTipo-tab" data-toggle="tab"
                                href="#filteractuacionesByTipo" role="tab" aria-controls="filteractuacionesByTipo"
                                aria-selected="true"><i style="margin-right: 11px;" class="fas fa-city"></i> <b>BY TYPE
                                    OF ACTUATION</b></a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="countactuaciones-tab" data-toggle="tab" href="#countactuaciones"
                                role="tab" aria-controls="countactuaciones" aria-selected="true"><i
                                    style="margin-right: 11px;" class="fas fa-city"></i> <b>NUMBER OF ACTUATIONS BY
                                    TYPE</b></a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" id="filterActuacionesByNumHistorialFecha-tab" data-toggle="tab"
                                href="#filterActuacionesByNumHistorialFecha" role="tab"
                                aria-controls="filterActuacionesByNumHistorialFecha" aria-selected="true"><i
                                    style="margin-right: 11px;" class="fas fa-city"></i> <b>ACTIONS BY
                                    PATIENT</b></a>
                        </li>



                    </ul>
                </div>
                <hr>
                <div class="tab-content" id="myTabContent">

                    <div class="tab-pane fade" id="filteractuacionesByTipo" role="tabpanel" aria-labelledby="home-tab">
                        <form name="formMedicamento" method="POST" action="/actuaciones/filteractuacionesByTipo">
                            <label for="name">Introduce the action type:</label>
                            <input list="options" id="actuacion" name="actuacion" autocomplete="off">
                            <datalist id="options">
                                <option value="Imprimir RECETA">
                                <option value="Patient info: MANDATORY TSI">
                                <option value="Patient info: PATIENT FROM ANOTHER REGION">
                                <option value="PRM: Adverse effects">
                                <option value="Patient info: NEW MED (START)">
                                <option value="PRM: Drug interactions">
                                <option value="Patient info: CLINIC OPERATION RULES">
                                <option value="Follow-up: MEDICATION ADJUSTMENT">
                                <option value="ADHERENCIA (E. INFECCIOSAS)">
                                <option value="Patient info: ADMINISTRATION AND/OR RECONSTITUTION">
                                <option value="Patient info: MEDICATION STORAGE">
                                <option value="OTHER ACTIONS">
                                <option value="PRM: ERRORES DE MEDICACIÓN QUE LLEGAN AL PACIENTE">
                                <option value="Seguimiento: PÉRDIDA DE MEDICACION/ROTURA">
                                <option value="ADHERENCIA (GASTRO)">
                                <option value="Imprimir FACTURA PROVISIONAL">
                                <option value="ADHERENCIA (PEDIATRIA)">
                                <option value="ADHERENCIA (NEUROLOGIA)">
                                <option value="Información al paciente: CITA">
                                <option value="Autorización: UFI NO TRAMITADO">
                                <option value="ADHERENCIA (REUMATOLOGIA)">
                                <option value="Validación: ADAPTAR ESPECIALIDAD/DOSIS">
                                <option value="Validación: INDICACION EN INICIO DE TRATAMIENTO">
                                <option value="Autorización: COMPROBADOS DATOS MEDICOS EN WEB SERMAS">
                                <option value="Validación: ACTUALIZACIÓN DATOS CLÍNICOS">
                                <option value="ADHERENCIA (OTROS SERVICIOS)">
                                <option value="Imprimir JUSTIFICANTE DE ASISTENCIA">
                                <option value="PRM: Características personales">
                                <option value="PRM: Conservación inadecuada">
                                <option value="PRM: Contraindicación">
                                <option value="PRM: Dosis/pauta/duración no adecuada">
                                <option value="PRM: Duplicidad">
                                <option value="PRM: Error de administración">
                                <option value="PRM: Error de dispensación">
                                <option value="PRM: Error de prescripción">
                                <option value="PRM: Otros">
                                <option value="PRM: Otros problemas de salud que afectan al tratamiento">
                                <option value="PRM: Problema de salud insuficientemente tratado">
                                <option value="Autorización: PROTOCOLO HORMONA DE CRECIMIENTO">
                                <option value="INFORMACIÓN UAF-PEX">
                                <option value="Información al paciente: SIN RECETA">
                                <option value="ADHERENCIA (HEMATOLOGÍA)">
                                <option value="Seguimiento: FARMACOTERAPÉUTICO/CLÍNICO">
                                <option value="Validación: CLARIFICACIÓN DE LA PRESCRIPCIÓN">
                                <option value="Validación: CONCILIACION DE TTO PRESENCIAL O TLF">
                                <option value="ADHERENCIA (ONCOLOGÍA)">
                                <option value="ADHERENCIA (DERMATOLOGÍA)">
                                <option value="Validación: CHEQUEO de INTERACCIONES en el tratamiento">
                                <option value="FELICITACIÓN VERBAL O ESCRITA">
                                <option value="PATIENT INCLUDED IN PHARMACY STUDY">
                                <option value="Validación: CONCILIACION DE TTO NO PRESENCIAL (HORUS)">
                                <option value="Seguimiento: REVISIÓN CON EL FARMACÉUTICO">
                                <option value="Autorización: MEX NO TRAMITADO">
                                <option value="Autorización: MUC NO TRAMITADO">
                                <option value="Autorización: MAI NO TRAMITADO">
                                <option value="Información al paciente: MED. NUEVO (CAMBIO)">
                                <option value="Estratificación">
                                <option value="Seguimiento: TELEFÓNICO. REVISIÓN">
                                <option value="Información al paciente: TELEFÓNICO. NUEVO o CAMBIO">
                                <option value="ENVÍO A DOMICILIO: otorga consentimiento informado">
                                <option value="ADHERENCIA (ENDOCRINO)">
                                <option value="ADHERENCIA (NEUMO)">
                                <option value="Autorización: MEDICAMENTO EXTRANJERO">
                                <option value="Autorización: MEDICAMENTO USO COMPASIVO">
                                <option value="Autorización: MEDICAMENTO USO FUERA DE INDICACIÓN">
                                <option value="Autorización: MEDICAMENTO EN INDICACIÓN FT (MAI)">
                                <option value="Devolución medicación">
                                <option value="Seguimiento: REVISIÓN PENDIENTE">
                                <option value="RAM notificada">
                                <option value="Seguimiento presencial: Cambio de dosis/frecuencia">
                                <option value="Seguimiento telefónico: Cambio de dosis/frecuencia">
                                <option value="ADHERENCIA (NEFROLOGIA)">
                            </datalist>
                            <p></p>
                            <div class="input-daterange input-group" id="datepicker">
                                <label for="name">Enter date range (YYYY-MM-DD):</label>
                                <input type="text" class="input-sm form-control" name="start" />
                                <span class="input-group-addon">to</span>
                                <input type="text" class="input-sm form-control" name="end" />
                            </div>
                            <p></p>
                            <button type="submit" class="btn btn-primary filter-button"><b>Filter</b></button>
                                onclick="filteractuacionesByTipo()">Search</button>
                        </form>
                    </div>

                    <div class="tab-pane fade" id="countactuaciones" role="tabpanel" aria-labelledby="home-tab">
                        <form name="formMedicamento" method="POST" action="/actuaciones/countactuaciones">
                            <fieldset>
                                <div class="form-group">
                                    <label for="name">Select the actuation type: </label>
                                    <input list="options" id="actuacion" name="actuacion" autocomplete="off">
                                    <datalist id="options">
                                        <option value="Imprimir RECETA">
                                        <option value="Información al paciente: TSI OBLIGATORIA">
                                        <option value="Información al paciente: PACIENTE DE OTRA CCAA">
                                        <option value="PRM: Efectos adversos">
                                        <option value="Información al paciente: MED. NUEVO (INICIO)">
                                        <option value="PRM: Interacciones medicamentosas">
                                        <option value="Información al paciente: NORMAS FUNCIONAMIENTO CONSULTA">
                                        <option value="Seguimiento: AJUSTE DE MEDICACION">
                                        <option value="ADHERENCIA (E. INFECCIOSAS)">
                                        <option value="Información al paciente: ADMINISTRACIÓN Y/O RECONSTITUCIÓN">
                                        <option value="Información al paciente: CONSERVACIÓN DE MEDICAMENTOS">
                                        <option value="OTRAS ACTUACIONES">
                                        <option value="PRM: ERRORES DE MEDICACIÓN QUE LLEGAN AL PACIENTE">
                                        <option value="Seguimiento: PÉRDIDA DE MEDICACION/ROTURA">
                                        <option value="ADHERENCIA (GASTRO)">
                                        <option value="Imprimir FACTURA PROVISIONAL">
                                        <option value="ADHERENCIA (PEDIATRIA)">
                                        <option value="ADHERENCIA (NEUROLOGIA)">
                                        <option value="Información al paciente: CITA">
                                        <option value="Autorización: UFI NO TRAMITADO">
                                        <option value="ADHERENCIA (REUMATOLOGIA)">
                                        <option value="Validación: ADAPTAR ESPECIALIDAD/DOSIS">
                                        <option value="Validation: INDICATION AT TREATMENT START">
                                        <option value="Autorización: COMPROBADOS DATOS MEDICOS EN WEB SERMAS">
                                        <option value="Validación: ACTUALIZACIÓN DATOS CLÍNICOS">
                                        <option value="ADHERENCIA (OTROS SERVICIOS)">
                                        <option value="Imprimir JUSTIFICANTE DE ASISTENCIA">
                                        <option value="PRM: Características personales">
                                        <option value="PRM: Conservación inadecuada">
                                        <option value="PRM: Contraindicación">
                                        <option value="PRM: Dosis/pauta/duración no adecuada">
                                        <option value="PRM: Duplicidad">
                                        <option value="PRM: Error de administración">
                                        <option value="PRM: Error de dispensación">
                                        <option value="PRM: Error de prescripción">
                                        <option value="PRM: Otros">
                                        <option value="PRM: Otros problemas de salud que afectan al tratamiento">
                                        <option value="PRM: Problema de salud insuficientemente tratado">
                                        <option value="Autorización: PROTOCOLO HORMONA DE CRECIMIENTO">
                                        <option value="INFORMACIÓN UAF-PEX">
                                        <option value="Información al paciente: SIN RECETA">
                                        <option value="ADHERENCIA (HEMATOLOGÍA)">
                                        <option value="Seguimiento: FARMACOTERAPÉUTICO/CLÍNICO">
                                        <option value="Validación: CLARIFICACIÓN DE LA PRESCRIPCIÓN">
                                        <option value="Validación: CONCILIACION DE TTO PRESENCIAL O TLF">
                                        <option value="ADHERENCIA (ONCOLOGÍA)">
                                        <option value="ADHERENCIA (DERMATOLOGÍA)">
                                        <option value="Validación: CHEQUEO de INTERACCIONES en el tratamiento">
                                        <option value="FELICITACIÓN VERBAL O ESCRITA">
                                        <option value="PATIENT INCLUDED IN PHARMACY STUDY">
                                        <option value="Validación: CONCILIACION DE TTO NO PRESENCIAL (HORUS)">
                                        <option value="Seguimiento: REVISIÓN CON EL FARMACÉUTICO">
                                        <option value="Autorización: MEX NO TRAMITADO">
                                        <option value="Autorización: MUC NO TRAMITADO">
                                        <option value="Autorización: MAI NO TRAMITADO">
                                        <option value="Información al paciente: MED. NUEVO (CAMBIO)">
                                        <option value="Estratificación">
                                        <option value="Seguimiento: TELEFÓNICO. REVISIÓN">
                                        <option value="Información al paciente: TELEFÓNICO. NUEVO o CAMBIO">
                                        <option value="ENVÍO A DOMICILIO: otorga consentimiento informado">
                                        <option value="ADHERENCIA (ENDOCRINO)">
                                        <option value="ADHERENCIA (NEUMO)">
                                        <option value="Autorización: MEDICAMENTO EXTRANJERO">
                                        <option value="Autorización: MEDICAMENTO USO COMPASIVO">
                                        <option value="Autorización: MEDICAMENTO USO FUERA DE INDICACIÓN">
                                        <option value="Autorización: MEDICAMENTO EN INDICACIÓN FT (MAI)">
                                        <option value="Devolución medicación">
                                        <option value="Seguimiento: REVISIÓN PENDIENTE">
                                        <option value="RAM notificada">
                                        <option value="Seguimiento presencial: Cambio de dosis/frecuencia">
                                        <option value="Seguimiento telefónico: Cambio de dosis/frecuencia">
                                        <option value="ADHERENCIA (NEFROLOGIA)">
                                    </datalist>
                                </div>
                            </fieldset>
                            <p></p>
                            <div class="input-daterange input-group" id="datepicker">
                                <label for="name">Introduce the dates interval (AAAA-MM-DD):</label>
                                <input type="text" class="input-sm form-control" name="start" />
                                <span class="input-group-addon">a</span>
                                <input type="text" class="input-sm form-control" name="end" />
                            </div>
                            <p></p>
                            <button type="submit" class="btn btn-primary filter-button"
                                onclick="countactuaciones()">Count</button>
                        </form>
                    </div>

                    <div class="tab-pane fade" id="filterActuacionesByNumHistorialFecha" role="tabpanel"
                        aria-labelledby="home-tab">
                        <form name="formHistorialActuaciones" method="POST"
                            action="/actuaciones/filterActuacionesByNumHistorialFecha">
                            <label for="name">Enter patient's record number: </label>
                            <input type="text" name="paciente_id" id="paciente_id" required></input>
                            <p></p>
                            <div class="input-daterange input-group" id="datepicker">
                                <label for="name">Enter date range (YYYY-MM-DD):</label>
                                <input type="text" class="input-sm form-control" name="start" />
                                <span class="input-group-addon">to</span>
                                <input type="text" class="input-sm form-control" name="end" />
                            </div>
                            <p></p>
                            <button type="submit" class="btn btn-primary filter-button"
                                onclick="filterActuacionesByNumHistorialFecha()">Search</button>
                        </form>
                    </div>





                </div>
            </div>


            <div class="col-xl-9 col-lg-8 col-md-9 col-sm-12">
                <div class="row content-info">
                    <div class="page-header">
                        <h1 id="tables">ACTUATION STATISTICS</h1>
                    </div>


                    <% if (typeof start !=='undefined' && typeof end !=='undefined' ) { %>
                        <div class="date-range-info col-12">
                            <strong>Analized date range:</strong>
                            <%= new Date(start).toLocaleDateString('es-ES') %> -
                                <%= new Date(end).toLocaleDateString('es-ES') %>
                        </div>
                        <% } %>


                            <div class="col-12">
                                <div class="stats-card text-center">
                                    <div class="stats-label">TOTAL OF ACTIONS</div>
                                    <div class="stats-number">
                                        <%= cuenta %>
                                    </div>
                                    <div class="text-muted">
                                        <% if (typeof tipo_stats !=='undefined' && Object.keys(tipo_stats).length> 0) {
                                            %>
                                            They are in <%= Object.keys(tipo_stats).length %> diferent types
                                                <% } %>
                                    </div>
                                </div>
                            </div>




                            <div class="col-12">
                                <div class="stats-card">
                                    <h4>Detail by type of actuation</h4>



                                    <div class="actuaciones-table">
                                        <table class="table table-hover table-striped">
                                            <thead class="bg-secondary">
                                                <tr>
                                                    <th scope="col">Type of actuation</th>
                                                    <th scope="col">Number of actions</th>
                                                    <th scope="col">Percentage</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% if (typeof tipo_stats !=='undefined' &&
                                                    Object.keys(tipo_stats).length> 0) { %>
                                                    <% const sortedActuaciones=Object.entries(tipo_stats).sort((a, b)=>
                                                        b[1] - a[1]);
                                                        sortedActuaciones.forEach(function([actuacion, count]) {
                                                        const percentage = ((count / cuenta) * 100).toFixed(2);
                                                        %>
                                                        <tr>
                                                            <td><strong>
                                                                    <%= actuacion %>
                                                                </strong></td>
                                                            <td>
                                                                <%= count %>
                                                            </td>
                                                            <td>
                                                                <div class="progress">
                                                                    <div class="progress-bar" role="progressbar"
                                                                        aria-valuenow="<%= percentage %>"
                                                                        aria-valuemin="0" aria-valuemax="100">
                                                                        <%= percentage %>%
                                                                    </div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        <% }); %>
                                                            <% } else { %>
                                                                <tr>
                                                                    <td colspan="3" class="text-center">No data
                                                                        available</td>
                                                                </tr>
                                                                <% } %>
                                            </tbody>
                                            <tfoot class="bg-light">
                                                <tr>
                                                    <th>TOTAL</th>
                                                    <th>
                                                        <%= cuenta %>
                                                    </th>
                                                    <th>100%</th>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>


                            <div class="col-12">
                                <div class="stats-card">
                                    <button class="btn btn-info" type="button" data-toggle="collapse"
                                        data-target="#actuacionesList">
                                        <i class="fas fa-list"></i> Complete list of actions
                                    </button>

                                    <div class="collapse" id="actuacionesList">
                                        <div class="mt-3" style="max-height: 500px; overflow-y: auto;">
                                            <table class="table table-sm table-hover">
                                                <thead class="thead-light">
                                                    <tr>
                                                        <th>Actuation</th>
                                                        <th>Date</th>
                                                        <th>Pacient ID</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <% if (datos && datos.length> 0) { %>
                                                        <% datos.forEach(function(actuacion) { %>
                                                            <tr>
                                                                <td>
                                                                    <%= actuacion.actuacion %>
                                                                </td>
                                                                <td>
                                                                    <%= actuacion.fecha ? new
                                                                        Date(actuacion.fecha).toLocaleDateString('es-ES')
                                                                        : 'Sin fecha' %>
                                                                </td>
                                                                <td>
                                                                    <span class="badge badge-secondary">
                                                                        <%= actuacion.paciente_id || '' %>
                                                                    </span>
                                                                </td>
                                                            </tr>
                                                            <% }); %>
                                                                <% } %>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            $('.pacient-alert').fadeOut({ duration: 3000 });

            if ($('div.input-daterange').length) {
                $('div.input-daterange').datepicker({
                    format: 'yyyy-mm-dd'
                });
            }

            // Crear gráficos si hay datos
            if (typeof tipo_stats !== 'undefined' && Object.keys(tipo_stats).length > 0) {
                // CORREGIDO: No usar JSON.stringify, ya es un objeto
                const actuacionData = JSON.stringify(tipo_stats);
                const sortedEntries = Object.entries(actuacionData).sort((a, b) => b[1] - a[1]);

                // Top 10 para el gráfico de barras
                const top10 = sortedEntries.slice(0, 10);
                const labels = top10.map(entry => {
                    const label = entry[0];
                    return label.length > 30 ? label.substring(0, 30) + '...' : label;
                });
                const values = top10.map(entry => entry[1]);

                // Gráfico de barras
                const barCanvas = document.getElementById('actuacionesBarChart');
                if (barCanvas) {
                    new Chart(barCanvas.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Número de Actuaciones',
                                data: values,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                }

                // Gráfico circular - Top 5 + Otros
                const top5 = sortedEntries.slice(0, 5);
                const others = sortedEntries.slice(5);
                const othersSum = others.reduce((sum, entry) => sum + entry[1], 0);

                const pieLabels = top5.map(e => e[0].length > 25 ? e[0].substring(0, 25) + '...' : e[0]);
                const pieValues = top5.map(e => e[1]);

                if (othersSum > 0) {
                    pieLabels.push('Otros');
                    pieValues.push(othersSum);
                }

                const colors = generateColors(pieLabels.length);

                const pieCanvas = document.getElementById('actuacionesPieChart');
                if (pieCanvas) {
                    new Chart(pieCanvas.getContext('2d'), {
                        type: 'pie',
                        data: {
                            labels: pieLabels,
                            datasets: [{
                                data: pieValues,
                                backgroundColor: colors,
                                borderColor: '#fff',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right'
                                }
                            }
                        }
                    });
                }
            }
        });

        function generateColors(count) {
            const colors = [];
            for (let i = 0; i < count; i++) {
                const hue = (i * 360 / count) % 360;
                colors.push(`hsla(${hue}, 70%, 60%, 0.8)`);
            }
            return colors;
        }

        function exportToCSV() {
            if (typeof tipo_stats !== 'undefined') {
                const data = JSON.stringify(tipo_stats);
                let csv = 'Tipo de Actuación,Número de Actuaciones,Porcentaje\n';
                const total = cuenta;

                Object.entries(data).forEach(([actuacion, count]) => {
                    const percentage = ((count / total) * 100).toFixed(2);
                    csv += `"${actuacion.replace(/"/g, '""')}",${count},${percentage}%\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'estadisticas_actuaciones.csv';
                a.click();
                URL.revokeObjectURL(url);
            }
        }
    </script>
</body>

</html>